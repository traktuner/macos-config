#!/usr/bin/env bash
set -euo pipefail

# Prevent running as root
if [[ $(id -u) -eq 0 ]]; then
  echo "❌ Please do NOT run bootstrap.sh as root. Aborting."
  exit 1
fi

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$ROOT_DIR" || { echo "❌ Could not cd to $ROOT_DIR"; exit 1; }

# Load shared functions
source "$ROOT_DIR/core/functions.sh"

# Export for subshells
export ROOT_DIR
export -f ask_for_confirmation ask_for_sudo answer_is_yes
export -f print_info print_success print_error
export -f symlink_from_to modify_file modify_line
export -f insert_to_file_after_line_number uncomment_line prepend_string_to_file
export -f line_exists add_config get_arch
export -f retry safe_defaults_write safe_plistbuddy safe_killall
export -f ensure_directory download_file bootstrap_launch_agent tm_snapshot

ask_for_sudo

ask_for_confirmation "⚠️ This will overwrite your workspace. Continue?"
answer_is_yes || { print_info "Aborted."; exit 0; }

print_info "Running all setup scripts…"
for script in "$ROOT_DIR/utils/"*.sh; do
  if [[ -x "$script" ]]; then
    print_info "➡️  $(basename "$script")"
    bash "$script" || print_error "Failed:" "$script"
  else
    print_info "Skipping non-executable $(basename "$script")"
  fi
done

exec bash
